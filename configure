#!/bin/sh
# 
# Copyright (c) 2014 Poul-Henning Kamp
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
# 
# Handwritten configure script.
# =============================
#
# Before you suggest I use tools for this, please read:
#
#	https://www.varnish-cache.org/docs/trunk/phk/autocrap.html
# and
#	http://queue.acm.org/detail.cfm?id=2349257
#

set -e

# List of .h files
# NB: These SHALL always be included with #include "..."

HDRS='
	ntimed.h
	ntimed_endian.h
	ntimed_queue.h
	ntimed_tricks.h
	ntp.h
	ntp_tbl.h
	param_instance.h
	param_tbl.h
	udp.h
'

# List of .c files

SRCS='
	combine_delta.c
	main.c
	main_client.c
	main_poll_server.c
	main_sim_client.c
	ntp_filter.c
	ntp_packet.c
	ntp_peer.c
	ntp_peerset.c
	ntp_tools.c
	ocx_stdio.c
	param.c
	pll_std.c
	suckaddr.c
	time_sim.c
	time_stuff.c
	time_unix.c
	todo.c
	udp.c
'

if make -v 2>&1 | grep GNU > /dev/null 2>&1 ; then
	echo "make(1) is GNU make."
	BSD=false
elif [ -f /usr/share/mk/bsd.prog.mk ] ; then
	echo "Found bsd.prog.mk, will use it."
	BSD=true
else
	echo "Defaulting to plain makefile"
	BSD=false
fi

if $BSD ; then
	(
	echo '# BSD-style Makefile generated by configure'
	echo 'PROG	=	ntimed-client'
	for f in ${SRCS}
	do
		echo "SRCS	+=	${f}"
	done

	echo 'NO_MAN	=	not_yet'
	echo 'LDADD	+=	-lm'
	echo 'WARNS	?=	6'
	echo '.include <bsd.prog.mk>'
	) > Makefile

	msg=", remember to run 'make depend'"
else
	(
	echo '# Portable Makefile generated by configure'
	echo ''
	echo 'all:	ntimed-client'
	echo ''
	echo "CFLAGS += -Wall -Werror"
	echo ''
	echo "LDFLAGS += "
	echo ''

	for f in ${HDRS}
	do
		b=`basename $f .h`
		i=`sed -n -e '/#include.*"/{
			s/"$//
			s/.*"//
			p
		}' $f | sort -u`
		if [ "x${i}" != "x" ] ; then
			echo "${b}.h:	" ${i}
			echo "	touch ${b}.h"
			echo
		fi
	done
	
	l=""
	for f in ${SRCS}
	do
		b=`basename $f .c`
		i=`sed -n -e '/#include.*"/{
			s/"$//
			s/.*"//
			p
		}' $f | sort -u`
		echo "${b}.o:	${b}.c" ${i}
		echo
		l="${l} ${b}.o"
	done

	echo
	echo "ntimed-client:	${l}"
	echo "	\${CC} \${CFLAGS} \${LDFLAGS} -o ntimed-client ${l} -lm"
	echo
	echo "clean:"
	echo "	rm -f ${l} ntimed-client"
	echo
	echo "depend:"
	echo "	@echo Dependencies already done"
	) > Makefile
fi

echo "Makefile generated${msg}"
